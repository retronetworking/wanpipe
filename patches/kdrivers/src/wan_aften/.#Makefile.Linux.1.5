# ============================================================================
# Makefile	Multiprotocol WAN Router for Linux.  Make Script.
#
# Copyright	(c) 1995-1997 Sangoma Technologies Inc.  All Rights Reserved.
# ----------------------------------------------------------------------------
# Mar 27  2000  Nenad Corbic	Version 2.0.5 to 2.1.2
# Jan 07, 1999	Jaspreet Singh	Version 2.0.4
# Aug 25, 1998	Jaspreet Singh  Version 2.0.3
# Nov 06, 1997	Jaspreet Singh	Version 2.0.0
# Jul 28, 1997	Jaspreet Singh  Version 1.0.5
# Jul 10, 1997  Jaspreet Singh	Version 1.0.4
# June 3, 1997	Jaspreet Singh	Version 1.0.3	
# Jan 15, 1997	Gene Kozin	Version 1.0.1.
# Dec 31, 1996	Gene Kozin	Initial version.
# ============================================================================

####### DEFINES ##############################################################

ARCH	= i686

OUTDIR  = mod
TMPDIR  = tmp
MODDIR  = modinfo

KERN := $(shell grep 2.4 /usr/src/linux/include/linux/version.h)
KERN_V26 := $(shell grep 2.6 /usr/src/linux/include/linux/version.h)
SRCDIR	= patches/kdrivers/src/net

ifneq "${KERN}" ""

MODTYPE=o
K_WAN_DIR=drivers/net/wan

CFLAGS=-D__KERNEL__ -D__LINUX__ -Iinclude -I/usr/src/linux/include -Wall -Wstrict-prototypes -O2 -fomit-frame-pointer -fno-strict-aliasing -pipe -mpreferred-stack-boundary=2  -march=$(ARCH) -DMODULE 


else

ifneq "${KERN_V26}" ""

LD_ELF=-m elf_i386

MODTYPE=ko
K_WAN_DIR=drivers/net/wan

CFLAGS=-Wp,-MD,.wan_aften.o.d -nostdinc -iwithprefix include -D__KERNEL__ -D__LINUX__ -Iinclude -I/usr/src/linux/include  -Wall -Wstrict-prototypes -Wno-trigraphs -fno-strict-aliasing -fno-common -pipe -mpreferred-stack-boundary=2 -march=$(ARCH) -I/usr/src/linux/include/asm-i386/mach-default -O2  -DMODULE

else

MODTYPE=o
K_WAN_DIR=drivers/net

CFLAGS=-D__KERNEL__ -D__LINUX__ -Iinclude -I../include -I../include/common -Wall -Wstrict-prototypes -O2 -fomit-frame-pointer -fno-strict-aliasing -pipe -fno-strength-reduce -m486 -malign-loops=2 -malign-jumps=2 -malign-functions=2 

endif

endif

####### RULES ################################################################

all:	$(OUTDIR)/wan_aften.$(MODTYPE)
	@echo "Ok."

# ----- Multiprotocol WAN router module --------------------------------------


$(OUTDIR)/wan_aften.ko: $(OUTDIR)/wan_aften.o $(MODDIR)/wan_aften.mod.o
	ld $(LD_ELF) -r -o $@ $^
	chmod 664 $@

$(MODDIR)/wan_aften.mod.o:	$(MODDIR)/wan_aften.mod.c
	$(CC) $(CFLAGS) -DKBUILD_MODNAME=wan_aften -DKBUILD_BASENAME=wan_aften -c -o $@ $^
	chmod 664 $@

#----------------------------------------------------

$(OUTDIR)/wan_aften.o: $(TMPDIR)/wan_aften.o $(TMPDIR)/wanpipe_linux_iface.o
	ld $(LD_ELF) -r -o $@ $^
	chmod 664 $@


#-----------------------------------------------------

$(TMPDIR)/wan_aften.o:	wan_aften.c
	$(CC) $(CFLAGS) -DKBUILD_BASENAME=wan_aften -DKBUILD_MODNAME=wan_aften -c -o $@ $^
	chmod 664 $@

$(TMPDIR)/wanpipe_linux_iface.o:	wanpipe_linux_iface.c
	$(CC) $(CFLAGS) -DKBUILD_BASENAME=wanpipe_linux_iface -DKBUILD_MODNAME=wanpipe_linux_iface -c -o $@ $^
	chmod 664 $@

clean:
	rm -f wan_aften.$(MODTYPE)
	rm -f *.o
	rm -f mod/*.o
	rm -f tmp/*.o


install:
	install -D $(OUTDIR)/wan_aften.${MODTYPE} /lib/modules/$(shell uname -r)/kernel/net/wanrouter/wan_aften.${MODTYPE}
	depmod -a

uninstall:
	rm -f /lib/modules/$(shell uname -r)/kernel/net/wanrouter/wan_aften.${MODTYPE}
